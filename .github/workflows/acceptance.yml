name: Acceptance tests (Behat)

on:
  workflow_dispatch:
    inputs:
      tags:
        description: 'Execute tags'
        required: true
        default: '~@performance'
      moodle_branch:
        description: 'Moodle branch'
        required: true
        default: 'master'
      moodle_repository:
        description: 'Moodle repository'
        required: true
        default: 'https://github.com/moodle/moodle'
  pull_request:
    branches:
     - integration
     - unscheduled

jobs:
  behat:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:10
        env:
          POSTGRES_USER: 'postgres'
          POSTGRES_HOST_AUTH_METHOD: 'trust'
        ports:
          - 5432:5432
        options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 3
    steps:
    - name: Check out repository code
      uses: actions/checkout@v2
      with:
        path: app
    - name: Setup PHP 8.0
      uses: shivammathur/setup-php@v2
      with:
        php-version: 8.0
        ini-values: max_input_vars=5000
        coverage: none
    - name: Setup Node
      uses: actions/setup-node@v3
      with:
        node-version-file: 'app/.nvmrc'
    - name: Install npm packages
      run: cd ./app && npm ci --no-audit
    - name: Generate behat plugin
      run: cd ./app && npx gulp behat
      env:
        MOODLE_APP_BEHAT_PLUGIN_PATH: $GITHUB_PATH/plugin
    - name: Initialise moodle-plugin-ci
      run: |
        composer create-project -n --no-dev --prefer-dist moodlehq/moodle-plugin-ci ci ^3
        echo $(cd ci/bin; pwd) >> $GITHUB_PATH
        echo $(cd ci/vendor/bin; pwd) >> $GITHUB_PATH
        sudo locale-gen en_AU.UTF-8
        echo "NVM_DIR=$HOME/.nvm" >> $GITHUB_ENV
    - name: Install moodle-plugin-ci
      run: |
        moodle-plugin-ci install --plugin ./plugin --db-host=127.0.0.1
      env:
        DB: pgsql
        MOODLE_BRANCH: master
    - name: Run acceptance tests
      run: moodle-plugin-ci behat --profile chrome
